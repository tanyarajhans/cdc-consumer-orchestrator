# This workflow deploys the CDC consumer applications to AWS using Terraform and Docker.
# It builds Docker images for each consumer script, pushes them to ECR, and applies the Terraform configuration.
# The workflow is triggered on pushes to the main branch.
# The AWS credentials and region are provided through GitHub secrets.
# The consumer scripts are expected to be in the 'consumer_scripts' directory, and Terraform configurations in the 'terraform' directory.

name: CDC Consumer Deployment

on:
  push:
    branches:
      - main

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  PROJECT_NAME: "cdc-orchestrator"
  TF_VAR_project_name: "cdc-orchestrator"

jobs:
  deploy:
    name: Deploy CDC Consumers
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: ğŸš€ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region:            ${{ env.AWS_REGION }}

    - name: âœ… Verify AWS Connection
      run: |
        echo "ğŸ” Verifying AWS connection..."
        aws sts get-caller-identity --output table
        echo "âœ… AWS connection verified"
    
    - name: ğŸ” Discover Consumer Services
      run: |
        echo "ğŸ“‹ Discovering consumer services..."
        
        if [ ! -d "consumer_scripts" ]; then
          echo "âŒ ERROR: consumer_scripts directory not found!"
          exit 1
        fi
        
        CONSUMER_LIST=$(find consumer_scripts -maxdepth 1 -mindepth 1 -type d -exec basename {} \; | jq -R . | jq -s . | jq -c .)
        CONSUMER_COUNT=$(echo $CONSUMER_LIST | jq length)
        IMAGE_TAG=${GITHUB_SHA::7}

        echo "ğŸ“Š Found $CONSUMER_COUNT consumer(s): $CONSUMER_LIST"
        echo "ğŸ·ï¸  Image tag: $IMAGE_TAG"

        # Export to GitHub environment
        {
          echo "CONSUMER_LIST=$CONSUMER_LIST"
          echo "IMAGE_TAG=$IMAGE_TAG" 
          echo "TF_VAR_consumer_services=$CONSUMER_LIST"
          echo "TF_VAR_image_tag=$IMAGE_TAG"
        } >> $GITHUB_ENV

    - name: ğŸ› ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3

    - name: ğŸ” Terraform Validation & Linting
      working-directory: terraform
      run: |
        echo "ğŸ”§ Initializing Terraform..."
        terraform init -input=false
        
        echo "âœ… Validating Terraform configuration..."
        terraform validate
        
        echo "ğŸ“‹ Formatting check..."
        if ! terraform fmt -check -recursive; then
          echo "âŒ Terraform files need formatting. Run 'terraform fmt -recursive'"
          exit 1
        fi
        
        echo "âœ… Terraform validation completed"

    - name: ğŸ—ï¸ Deploy ECR Repositories
      working-directory: terraform
      run: |
        echo "ğŸ“Š Planning ECR repository changes..."
        terraform plan -input=false -target=aws_ecr_repository.cdc_consumer_orchestrator
        
        echo "ğŸš€ Creating ECR repositories..."
        terraform apply -input=false -auto-approve \
          -target=aws_ecr_repository.cdc_consumer_orchestrator
        
        echo "âœ… ECR repositories ready"

    - name: ğŸ³ Build & Push Docker Images
      run: |
        echo "ğŸ³ Building and pushing Docker images..."
        
        if [ "$CONSUMER_LIST" = "[]" ]; then
          echo "âš ï¸  No consumers found - skipping Docker operations"
          exit 0
        fi
        
        CONSUMER_ARRAY=$(echo $CONSUMER_LIST | jq -r '.[]')
        TOTAL_CONSUMERS=$(echo $CONSUMER_LIST | jq length)
        CURRENT=0
        
        for consumer in $CONSUMER_ARRAY; do
          CURRENT=$((CURRENT + 1))
          REPO="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${PROJECT_NAME}-${consumer}"
          
          echo "ğŸ“¦ [$CURRENT/$TOTAL_CONSUMERS] Processing: $consumer"
          echo "ğŸ·ï¸  Target: $REPO:$IMAGE_TAG"
          
          # Verify Dockerfile exists
          if [ ! -f "consumer_scripts/$consumer/Dockerfile" ]; then
            echo "âŒ ERROR: Dockerfile not found in consumer_scripts/$consumer/"
            exit 1
          fi
          
          # Build image
          echo "ğŸ”¨ Building Docker image..."
          docker build --platform linux/arm64 -t "$REPO:$IMAGE_TAG" "consumer_scripts/$consumer"
          
          # Login to ECR
          echo "ğŸ” Authenticating with ECR..."
          aws ecr get-login-password --region $AWS_REGION \
            | docker login --username AWS --password-stdin "$REPO"
          
          # Push image
          echo "ğŸ“¤ Pushing to ECR..."
          docker push "$REPO:$IMAGE_TAG"
          
          echo "âœ… Successfully processed $consumer"
        done
        
        echo ""
        echo "ğŸ‰ All Docker images built and pushed successfully!"

    - name: ğŸ“‹ Generate Deployment Plan
      working-directory: terraform
      run: |
        echo "ğŸ“‹ Generating Terraform deployment plan..."
        terraform plan -input=false -out=tfplan
        
    - name: ğŸš€ Deploy Infrastructure
      working-directory: terraform
      run: |
        echo "ğŸš€ Applying Terraform changes..."
        terraform apply -input=false -auto-approve tfplan
        echo "âœ… Infrastructure deployment completed"

    - name: ğŸ“Š Deployment Summary
      if: always()
      run: |
        echo ""
        echo "=============================================="
        echo "ğŸ“Š DEPLOYMENT SUMMARY"
        echo "=============================================="
        echo "ğŸ“‹ Commit: ${{ github.sha }}"
        echo "ğŸ·ï¸  Image Tag: ${IMAGE_TAG}"
        echo "ğŸ”¢ Consumers: $(echo ${CONSUMER_LIST} | jq length)"
        
        if [ "${CONSUMER_LIST}" != "[]" ]; then
          echo "ğŸ“¦ Services Deployed:"
          echo "${CONSUMER_LIST}" | jq -r '.[] | "  â€¢ \(.)"'
        fi
        
        echo "â° Completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… Status: SUCCESS"
          echo "ğŸ‰ CDC consumers are now live!"
        else
          echo "âŒ Status: FAILED"
          echo "ğŸ’¡ Check logs above for details"
        fi
        echo "=============================================="